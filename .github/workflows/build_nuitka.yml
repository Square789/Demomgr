name: Build nuitka distribution

on:
  push:
    branches:
      - 'master'
    tags:
      - 'v*'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build-windows:
    strategy:
      matrix:
        architecture: ['x86', 'x64']

    env:
      NUITKA_ASSUME_YES: 1
      NUITKA_COMPILER_USE_DEFAULT: 1
      BUILD_NAME: demomgr-win${{ matrix.architecture }}
      DEMOMGR_DIST_PATH: ./nuitka_build/demomgr.dist
      DEMOMGR_DIST_ZIP_PATH: ./nuitka_build/${{ env.ZIP_NAME }}.zip

    runs-on: windows-latest

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Checkout
        uses: actions/checkout@v2

      - name: Setup python
        uses: actions/setup-python@v2
        with:
          python-version: '3.8'
          architecture: ${{ matrix.architecture }}

      - name: Install wheel, nuitka and dependencies
        run: |
          pip install wheel
          pip install nuitka
          pip install -r requirements.txt

      - name: Build
        run: python setup_nuitka.py

      - name: Zip
        run: '7z a -tzip $DEMOMGR_DIST_ZIP_PATH $DEMOMGR_DIST_PATH'

      - name: Upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.BUILD_NAME }}
          path: $DEMOMGR_DIST_ZIP_PATH
